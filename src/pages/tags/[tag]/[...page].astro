---
import type { GetStaticPaths, Page } from 'astro';
import type { Post, NavigationItem } from '@utils/types';
import { generateUniqueTags, sortPostsDesc } from '@utils/scripts';
import { getCollection } from 'astro:content';
import GlobalWrapper from '@layouts/GlobalWrapper.astro';
import Intro from '@components/Intro.astro';
import PostGrid from '@components/PostGrid.astro';

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts: Post[] = await getCollection('posts');
  const uniqueTags = generateUniqueTags(allPosts);
  return uniqueTags.flatMap((tag: NavigationItem) => {
    const tagPosts = allPosts.filter((post: Post) =>
      post.data.tags.includes(tag.title)
    );
    return paginate(sortPostsDesc(tagPosts), {
      params: { tag: tag.url },
      props: { tagName: tag.title },
      pageSize: 1,
    });
  });
}) satisfies GetStaticPaths;

interface Props {
  page: Page<Post>;
  tagName: string;
}

const { page, tagName }: Props = Astro.props;
const { tag } = Astro.params;
---

<GlobalWrapper pageTitle={tagName}>
  <Intro slot="title" />
  <PostGrid
    slot="main"
    posts={page.data}
    prevPage={page.url.prev}
    nextPage={page.url.next}
    currentPage={page.currentPage}
    lastPage={page.lastPage}
  />
</GlobalWrapper>
