---
import type { Post, Topic } from '@utils/types';
import { getCollection } from 'astro:content';
import { formatDate, sortPostsDesc } from '@utils/scripts';
import GlobalWrapper from '@layouts/GlobalWrapper.astro';
import PageTitle from '@components/PageTitle.astro';
import TopicCard from '@components/feed/TopicCard.astro';

const posts = await getCollection('posts');
const topics = await getCollection('topics');
const lastUpdated = (topic: Topic): string => {
  const topicPosts: Post[] = posts.filter((post: Post) =>
    post.data.tags.includes(topic.data.title)
  );
  return formatDate(sortPostsDesc(topicPosts)[0].data.datePublished);
};
const topicItems = topics.map((topic: Topic) => {
  return {
    topic: topic,
    lastUpdated: lastUpdated(topic),
  };
});

const sortedTopicItems = () => {
  return topicItems.sort((prev, next) =>
    new Date(prev.lastUpdated) < new Date(next.lastUpdated) ? 1 : -1
  );
};
---

<GlobalWrapper pageTitle="Topics">
  <PageTitle slot="title" showPhoto={false} title="Topics" />
  <div slot="main" class="content">
    {sortedTopicItems().map((topic) => <TopicCard topic={topic} />)}
  </div>
</GlobalWrapper>

<style lang="scss">
  .content {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding-top: var(--space-100-160);
  }
</style>
